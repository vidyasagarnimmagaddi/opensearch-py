#!/usr/bin/env bash
#
# Entrypoint to run integration tests

set -euo pipefail

# Default environment variables
export TEST_SUITE="${TEST_SUITE:=oss}"
export PYTHON_VERSION="${PYTHON_VERSION:=3.9}"
export PYTHON_CONNECTION_CLASS="${PYTHON_CONNECTION_CLASS:=Urllib3HttpConnection}"
export CLUSTER="${CLUSTER:-opensearch}"
export SECURE_INTEGRATION="${1:-false}"
export OPENSEARCH_VERSION="${2:-latest}"
export TEST_PATTERN="${3:-}"

if [[ "$SECURE_INTEGRATION" == "true" ]]; then
    export OPENSEARCH_URL_EXTENSION="https"
else
    export OPENSEARCH_URL_EXTENSION="http"
fi

export OPENSEARCH_URL="${OPENSEARCH_URL_EXTENSION}://localhost:9200"
export opensearch_url="$OPENSEARCH_URL"  # required by run-repository.sh

export IS_UNRELEASED=false
if [[ "$OPENSEARCH_VERSION" == *"SNAPSHOT" ]]; then
  IS_UNRELEASED=true
fi

echo -e "\033[1m>>>>> Unreleased is $IS_UNRELEASED >>>>>>>>>>>>>>>>>>>>>>>>>>>>>\033[0m"
script_path=$(dirname "$(realpath "$0")")
export opensearch_node_name="opensearch-node"
source "$script_path/functions/imports.sh"


echo -e "\033[1m>>>>> Start server container >>>>>>>>>>>>>>>>>>>>>>>>>>>>>\033[0m"
DETACH=true bash .ci/run-opensearch.sh

# Wait for OpenSearch to become healthy
echo -e "\033[1m>>>>> Verifying OpenSearch is reachable at $OPENSEARCH_URL >>>>>>>>>>>>>>>>>>>>>>>>>>>>>\033[0m"
if [[ "$SECURE_INTEGRATION" == "true" ]]; then
  AUTH="-u admin:myStrongPassword123!"
  CURL_FLAGS="-k"
else
  AUTH=""
  CURL_FLAGS=""
fi

for i in {1..20}; do
  echo "Attempt $i: Checking $OPENSEARCH_URL"
  if curl -s $CURL_FLAGS $AUTH "$OPENSEARCH_URL" >/dev/null; then
    echo "✅ OpenSearch is reachable at $OPENSEARCH_URL"
    break
  fi
  echo "⌛ Still waiting..."
  sleep 5
done

if ! curl -s $CURL_FLAGS $AUTH "$OPENSEARCH_URL" >/dev/null; then
  echo "❌ OpenSearch never became reachable at $OPENSEARCH_URL"
  docker ps -a
  docker logs "$opensearch_node_name" || true
  exit 1
fi

# Optional additional containers
if [[ -n "${RUNSCRIPTS:-}" ]]; then
  for RUNSCRIPT in ${RUNSCRIPTS//,/ } ; do
    echo -e "\033[1m>>>>> Running run-$RUNSCRIPT.sh >>>>>>>>>>>>>>>>>>>>>>>>>>>>>\033[0m"
    CONTAINER_NAME=${RUNSCRIPT} \
      DETACH=true \
      bash .ci/run-${RUNSCRIPT}.sh
  done
fi

echo -e "\033[1m>>>>> Repository specific tests >>>>>>>>>>>>>>>>>>>>>>>>>>>>>\033[0m"
bash .ci/run-repository.sh
